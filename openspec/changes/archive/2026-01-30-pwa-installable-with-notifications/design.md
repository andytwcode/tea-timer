# Design: PWA 可安裝性與通知功能

## Context

泡茶計時器目前是基於 Vue 3 + Vite 的單頁應用，所有狀態管理都在前端完成，使用 localStorage 記憶使用者設定。應用已有完整的計時邏輯，包含單泡和連續沖泡模式。

**當前架構：**
- 前端框架：Vue 3 Composition API
- 建置工具：Vite
- 樣式：Tailwind CSS
- 狀態持久化：localStorage
- 部署：靜態網站（GitHub Pages）

**限制條件：**
- 純前端應用，無後端服務
- 需維持簡單架構，不引入複雜依賴
- 部署在 `/tea-timer/` 子路徑下

**利害關係人：**
- 使用者：希望快速啟動應用，不想每次輸入網址
- 開發者：希望實作簡單，易於維護

## Goals / Non-Goals

**Goals:**
- 使應用可透過瀏覽器「安裝」到裝置主畫面/桌面
- 安裝後以全螢幕模式執行，提供類原生 app 體驗
- 計時完成時發送系統通知（包含震動）
- 通知內容依據計時模式（單泡/連續沖泡）顯示適當訊息
- 通知點擊後能聚焦應用視窗

**Non-Goals:**
- 不實作 Service Worker 背景同步（前景通知已足夠）
- 不實作離線快取（應用本身已是靜態檔案，離線功能價值不高）
- 不實作通知內的互動按鈕（需 Service Worker，增加複雜度）
- 不實作推送通知（無後端服務，也不需要）
- 不處理舊版瀏覽器相容性（專注於現代瀏覽器）

## Decisions

### Decision 1: 使用 Web App Manifest 實作可安裝性

**選擇：** 建立標準的 `manifest.json` 檔案，包含應用基本資訊和圖標。

**理由：**
- Web App Manifest 是 PWA 的標準做法，瀏覽器原生支援
- 配置簡單，只需 JSON 檔案即可
- 無需額外依賴或建置步驟

**替代方案考量：**
- ❌ 不使用 manifest：無法觸發瀏覽器的「安裝」提示
- ❌ 使用第三方 PWA 框架：過度工程，增加複雜度

**具體配置：**
```json
{
  "name": "泡茶計時器",
  "short_name": "泡茶",
  "start_url": "./",
  "display": "standalone",
  "theme_color": "#16a34a",
  "background_color": "#f0fdf4"
}
```

### Decision 2: 圖標尺寸和格式策略

**選擇：** 提供 192x192 和 512x512 兩個必要尺寸，加上 180x180 給 iOS。

**理由：**
- 192 和 512 是 Android PWA 的必要尺寸
- 180x180 是 iOS `apple-touch-icon` 的推薦尺寸
- PNG 格式相容性最佳

**替代方案考量：**
- ❌ 只提供單一尺寸：各平台顯示效果差，可能無法安裝
- ❌ 使用 SVG：Manifest 對 SVG 支援度不一致
- ❌ 提供完整 maskable icon 集：增加複雜度，非必要

**圖標來源：**
- 使用者提供的 Gemini 生成圖檔（中文「茶」字 + 綠色主題）
- 使用圖片處理工具縮放到需要的尺寸

### Decision 3: 通知權限請求時機

**選擇：** 應用啟動時（`onMounted`）立即檢查並請求通知權限。

**理由：**
- 使用者安裝後首次開啟，立即建立通知權限是合理的
- 計時器的核心價值就是提醒，權限是必要的
- 避免首次計時完成時才請求，造成錯過通知的困擾

**替代方案考量：**
- ❌ 首次計時完成時才請求：使用者可能錯過第一次通知
- ❌ 提供設定頁面讓使用者選擇：增加複雜度，大多數使用者會需要通知
- ✓ 如果權限被拒絕，仍可正常計時（優雅降級）

**實作細節：**
```javascript
onMounted(() => {
  if ('Notification' in window && Notification.permission === 'default') {
    Notification.requestPermission()
  }
})
```

### Decision 4: 通知內容格式

**選擇：** 單泡和連續沖泡顯示不同的通知內容，包含圖標和震動。

**通知格式：**
- **單泡模式**：`title: "泡茶時間到！"`, `body: "時間到了！"`
- **連續沖泡模式**：`title: "泡茶時間到！"`, `body: "第 X 泡已完成"`

**理由：**
- 標題統一，使用者一眼辨識
- 內容區分模式，提供上下文資訊
- 圖標使用應用 icon，強化品牌識別
- 震動模式使用短促三次（200-100-200），足夠引起注意但不過度干擾

**替代方案考量：**
- ❌ 通知內容包含下一泡時間：資訊過多，可能被截斷
- ❌ 使用不同圖標區分模式：增加資產管理複雜度
- ❌ 可配置通知文字：過度設計，預設文案已足夠

### Decision 5: 通知點擊行為

**選擇：** 點擊通知時聚焦應用視窗（`window.focus()`），並關閉通知。

**理由：**
- 使用者點擊通知，期待是回到應用查看狀態
- 關閉通知避免通知列堆積
- 簡單實作，不需要 Service Worker

**實作細節：**
```javascript
notification.onclick = () => {
  window.focus()
  notification.close()
}
```

### Decision 6: 不使用 Service Worker

**選擇：** 這次變更不引入 Service Worker。

**理由：**
- **前景通知已足夠**：計時器使用情境是保持應用開啟，切換到其他 app 仍可收到通知
- **背景計時不可靠**：手機系統會暫停背景計時器以省電，實際效果不佳
- **簡化架構**：避免 SW 的生命週期管理、更新策略等複雜性
- **靜態網站特性**：應用本身已經離線可用（只要快取過），不需額外離線策略

**未來可擴充：**
- 若未來需要真正的背景通知，可考慮整合 Service Worker
- 若需要離線優先策略，可加入快取策略

## Risks / Trade-offs

### Risk 1: 通知權限被拒絕

**風險：** 使用者可能拒絕通知權限，或在系統設定中禁用。

**緩解措施：**
- 應用仍可正常計時，只是缺少通知提醒
- 不顯示錯誤訊息，優雅降級
- 未來可考慮在 UI 上提示使用者「已完成」狀態（視覺提示）

### Risk 2: iOS Safari 的 PWA 限制

**風險：** iOS Safari 對 PWA 的支援度較低，部分功能可能不如預期。

**緩解措施：**
- 使用 `apple-touch-icon` 確保 iOS 可將應用加入主畫面
- 接受 iOS 上可能無法像 Android 一樣觸發「安裝」提示
- iOS 通知權限管理較嚴格，使用者需手動授權

### Risk 3: 前景通知的限制

**風險：** 如果使用者關閉應用分頁，將無法收到通知。

**緩解措施：**
- 這是設計取捨，目前認為「保持應用開啟」是合理的使用情境
- 未來若使用者反饋需要背景通知，可考慮引入 Service Worker
- 在應用介紹中說明使用方式（保持應用開啟即可）

### Risk 4: 子路徑部署的 manifest 路徑

**風險：** 應用部署在 `/tea-timer/` 子路徑，`start_url` 需正確配置。

**緩解措施：**
- 使用相對路徑 `"./"` 作為 `start_url`
- 在 Vite 配置中確保 base 路徑正確
- 測試安裝後的啟動行為

### Trade-off: 圖標尺寸 vs 載入效能

**取捨：** 提供多尺寸圖標會增加一些資產大小。

**評估：**
- 3 個 PNG 檔案（192, 512, 180）總計約 50-100KB
- 相對於應用整體大小（Vue + Tailwind），影響微乎其微
- 使用者只在首次載入時下載，後續會被快取
- **結論：可接受的取捨，不需優化**

## Migration Plan

本變更為新增功能，無需資料遷移或向下相容性處理。

**部署步驟：**
1. 將圖標檔案放入 `public/icons/` 目錄
2. 建立 `public/manifest.json`
3. 更新 `index.html`（加入 manifest link 和 meta tags）
4. 修改 `src/App.vue`（加入通知邏輯）
5. 建置並部署到 GitHub Pages
6. 測試：在 Android Chrome 和 iOS Safari 上測試安裝和通知功能

**回滾策略：**
- 如果通知功能有問題，可移除 App.vue 中的通知程式碼，保留 manifest
- Manifest 本身無副作用，即使不移除也不影響現有功能
- 圖標檔案為靜態資產，不影響應用執行

**驗證清單：**
- [ ] Android Chrome 可顯示「安裝」提示
- [ ] 安裝後應用以 standalone 模式啟動
- [ ] 計時完成時發送通知
- [ ] 通知點擊後回到應用
- [ ] iOS Safari 可「加入主畫面」
- [ ] 拒絕通知權限時應用仍可正常使用

## Open Questions

1. **通知聲音**：瀏覽器預設的通知聲音是否足夠？是否需要自訂音效？
   - 目前決定：使用系統預設，避免增加音效資產和複雜度

2. **震動模式**：目前使用 `[200, 100, 200]`，是否需要調整？
   - 需實測後決定，可能在 tasks 階段微調

3. **圖標 maskable 版本**：是否需要提供 maskable icon 以適應不同裝置的裁切？
   - 目前決定：非必要，如果使用者回饋顯示異常再補充

4. **通知持久性**：是否使用 `requireInteraction: true` 強制使用者手動關閉通知？
   - 目前決定：使用，確保使用者不會錯過通知
